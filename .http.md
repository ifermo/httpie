本文详细阐述和总结了 IntelliJ IDEA 支持的 `.http` 文件格式（也称为 HTTP Client）的规则和语法。

`.http` 文件是 IntelliJ IDEA (以及其他 JetBrains IDE) 提供的一项强大功能，它允许开发者在 IDE 中直接编写、执行和管理 HTTP 请求。这种方式将 API 请求以纯文本的形式管理，非常适合版本控制、团队协作和自动化测试。

### 核心概念

  * **纯文本:** 所有请求都以人类可读的纯文本格式编写。
  * **请求分离:** 使用 `###` 分隔符可以在一个文件中定义多个独立的请求。
  * **环境与变量:** 支持定义变量和环境（如开发、测试、生产），以轻松切换配置。
  * **响应处理:** 可以编写 JavaScript 脚本来处理响应，例如断言测试或从响应中提取数据用于后续请求。

-----

### 1\. 基本语法结构

一个最基本的请求由请求方法 (Method)、URL 和可选的 HTTP 版本组成。

```http
### 这是一个简单的 GET 请求
GET https://api.github.com/users/octocat
```

**结构分解:**

1.  **注释 (Comments):**

      * 以 `//` 或 `#` 开头的行被视为注释。

2.  **请求分隔符 (Request Separator):**

      * 使用 `###` 来分隔文件中的多个请求。你可以为每个分隔符后的请求添加一个描述性的名称。

    <!-- end list -->

    ```http
    ### 获取用户信息
    GET https://example.com/api/users/1

    ### 创建一个新用户
    POST https://example.com/api/users
    ```

3.  **请求行 (Request Line):**

      * 格式为: `METHOD Request-URI HTTP/version`。
      * `METHOD`: 必需，如 `GET`, `POST`, `PUT`, `DELETE`, `PATCH`, `HEAD`, `OPTIONS` 等。
      * `Request-URI`: 必需，请求的目标地址。
      * `HTTP/version`: 可选，如 `HTTP/1.1`。如果省略，通常默认为 `HTTP/1.1`。

-----

### 2\. 请求的组成部分

一个完整的 HTTP 请求通常包含请求头和请求体。

#### 2.1 请求头 (Request Headers)

  * 紧跟在请求行之后。
  * 格式为 `Header-Name: Header-Value`。
  * 每个头信息占一行。

<!-- end list -->

```http
### 带请求头的请求
GET https://httpbin.org/get
Accept: application/json
User-Agent: IntelliJ-HTTP-Client
X-Custom-Header: MyValue
```

#### 2.2 请求体 (Request Body)

  * 请求体与请求头之间必须用 **一个空行** 隔开。
  * 请求体的内容和格式取决于 `Content-Type` 请求头。

**常见 `Content-Type` 示例:**

  * **`application/json`**

    ```http
    POST https://httpbin.org/post
    Content-Type: application/json

    {
      "name": "gemini",
      "type": "ai",
      "features": [
        "code",
        "text",
        "translation"
      ]
    }
    ```

  * **`application/x-www-form-urlencoded`** (表单提交)

    ```http
    POST https://httpbin.org/post
    Content-Type: application/x-www-form-urlencoded

    name=gemini&type=ai
    ```

  * **`multipart/form-data`** (文件上传)

      * IDE 会自动处理边界 (boundary)。
      * 可以直接在请求体中定义表单字段。

    <!-- end list -->

    ```http
    POST https://httpbin.org/post
    Content-Type: multipart/form-data

    --MyBoundary
    Content-Disposition: form-data; name="text-field"

    Some text value
    --MyBoundary
    Content-Disposition: form-data; name="file-field"; filename="example.txt"
    Content-Type: text/plain

    < ./path/to/your/file.txt
    --MyBoundary--
    ```

    **注意:** 使用 `<` 符号可以直接从文件中读取内容作为请求体或表单字段的值。

  * **纯文本、XML、GraphQL 等**

      * 只需设置对应的 `Content-Type` 并直接编写内容即可。

    <!-- end list -->

    ```http
    POST https://example.com/api/xml
    Content-Type: application/xml; charset=utf-8

    <root>
        <item>Value</item>
    </root>
    ```

#### 2.3 从文件读取请求体

你可以使用 `<` 重定向符号从文件中加载整个请求体。

```http
POST https://httpbin.org/post
Content-Type: application/json
< ./data.json
```

-----

### 3\. 变量和环境

这是 HTTP Client 最强大的功能之一，可以避免硬编码值。

#### 3.1 变量语法

  * 使用双花括号 `{{variable_name}}` 来引用一个变量。

    ```http
    GET https://{{host}}/api/users
    Authorization: Bearer {{auth_token}}
    ```

#### 3.2 变量的定义方式

1.  **文件内定义:**

      * 使用 `@variable_name = value` 的语法在 `.http` 文件顶部或任何请求之前定义。这种变量的作用域是整个文件。

    <!-- end list -->

    ```http
    @host = https://httpbin.org
    @token = my-secret-token

    ### 使用文件内定义的变量
    GET {{host}}/get
    Authorization: Bearer {{token}}
    ```

2.  **环境文件 (Environment Files):**

      * 这是管理不同环境（如开发、测试、生产）配置的最佳实践。
      * **`http-client.env.json`:** 公共环境文件，可以提交到版本控制系统。
      * **`http-client.private.env.json`:** 私有环境文件，用于存储敏感数据（如密码、token），应被 `gitignore` 忽略。

    **`http-client.env.json` 文件示例:**

    ```json
    {
      "development": {
        "host": "localhost:8080",
        "user_id": "123"
      },
      "production": {
        "host": "api.production.com",
        "user_id": "456"
      }
    }
    ```

    在 IDE 中，你可以轻松地在右上角的运行配置下拉菜单中切换不同的环境。

3.  **动态变量 (Dynamic Variables):**

      * IDE 提供了一些内置的动态变量，每次请求时都会生成新值。
      * `{{$uuid}}`: 生成一个 UUID。
      * `{{$timestamp}}`: 生成当前的 Unix 时间戳 (秒)。
      * `{{$randomInt}}`: 生成一个 0 到 1000 之间的随机整数。
      * `{{$processEnv.ENV_VAR}}`: 读取系统环境变量。

-----

### 4\. 响应处理器脚本 (Response Handler Scripts)

你可以在请求之后编写 JavaScript (ECMAScript 5.1) 脚本来处理响应。

  * **语法:** 脚本块以 `>` 开头，并用 `{% ... %}` 包裹。
  * **用途:**
      * **测试/断言:** 验证响应状态码、头信息和内容。
      * **变量捕获:** 从响应中提取数据（如认证令牌），并将其存入全局变量，供后续请求使用。

#### 4.1 核心对象

  * **`client` 对象:**

      * `client.global.set("variable_name", "value")`: 设置一个全局变量，可在文件中所有后续请求中使用。
      * `client.test("Test Name", function() { ... })`: 定义一个测试用例。
      * `assert(condition, "message")`: 在测试中断言条件是否为真。

  * **`response` 对象:**

      * `response.status`: HTTP 状态码 (如 `200`, `404`)。
      * `response.headers`: 包含所有响应头的对象。
      * `response.body`: 响应体。如果是 JSON，它会自动被解析为 JavaScript 对象。
      * `response.contentType`: 响应的 `Content-Type`。

#### 4.2 示例

```http
### 1. 登录并获取 Token
POST https://example.com/api/login
Content-Type: application/json

{
  "username": "user",
  "password": "password"
}

> {%
    // 测试状态码是否为 200
    client.test("Login successful", function() {
        client.assert(response.status === 200, "Response status is not 200");
    });

    // 从响应体中提取 token 并存入全局变量
    const token = response.body.access_token;
    client.global.set("auth_token", token);
%}

### 2. 使用 Token 访问受保护的资源
GET https://example.com/api/profile
Authorization: Bearer {{auth_token}}

> {%
    client.test("Profile data is correct", function() {
        client.assert(response.status === 200, "Could not fetch profile");
        client.assert(response.body.username === "user", "Username does not match");
    });
%}
```

-----

### 语法快速参考总结

| 语法/符号 | 作用 | 示例 |
| :--- | :--- | :--- |
| `###` | 分隔不同的 HTTP 请求。 | `### Get all users` |
| `#` 或 `//` | 单行注释。 | `# This is a comment` |
| `@name = value` | 在文件内定义一个变量。 | `@host = https://example.com` |
| `{{variable}}` | 引用一个变量。 | `GET {{host}}/api` |
| `>` | 标记请求结束，开始响应处理器脚本。 | `> {% client.test(...); %}` |
| `< path/to/file`| 从文件中读取内容作为请求体或表单字段值。 | `Content-Type: application/json`\<br\>`< ./payload.json` |
| `http-client.env.json` | 定义不同环境的公共变量。 | `{ "dev": { "host": ... } }` |
